<?xml version="1.0" encoding="UTF-8" standalone="no" ?>

<!--
  Copyright (c) 2016, 2021 IBM Corp. and others

  This program and the accompanying materials are made available under
  the terms of the Eclipse Public License 2.0 which accompanies this
  distribution and is available at https://www.eclipse.org/legal/epl-2.0/
  or the Apache License, Version 2.0 which accompanies this distribution and
  is available at https://www.apache.org/licenses/LICENSE-2.0.

  This Source Code may also be made available under the following
  Secondary Licenses when the conditions for such availability set
  forth in the Eclipse Public License, v. 2.0 are satisfied: GNU
  General Public License, version 2 with the GNU Classpath
  Exception [1] and GNU General Public License, version 2 with the
  OpenJDK Assembly Exception [2].

  [1] https://www.gnu.org/software/classpath/license.html
  [2] http://openjdk.java.net/legal/assembly-exception.html

  SPDX-License-Identifier: EPL-2.0 OR Apache-2.0 OR GPL-2.0 WITH Classpath-exception-2.0 OR LicenseRef-GPL-2.0 WITH Assembly-exception
-->

<!DOCTYPE suite SYSTEM "cmdlinetester.dtd"><suite id="J9 NUMA memory policy tests" timeout="60">
	<!-- Verify the correct memory policy is set by checking the heap from numa_maps -->
	<test id="default, JVM interleave off">
		<!-- default case, no command line options. -->
		<!-- Should result in no interleaving -->
		<!-- If this fails, see CMVC 194130 or Defect 59613 -->
		<command>$EXE$ -Xdump:java:events=user,file=javacore.txt -classpath  /team/pdbain/workspaces/jvm.29/j9vm_test/bin:$Q$$J9JAR$$Q$ com.ibm.j9.numa.LinuxNumaTest default</command>
		<output regex="yes" type="success">.*TEST PASSED*</output>
		<output regex="yes" type="failure">.*TEST FAILED*</output>
 	</test>
	<test id="interleaveOnlyNode0, JVM interleave off">
		<!-- 64-bit references, default policy limited to node 0 only -->
		<!-- Should result in "bind" policy -->
		<!-- If this fails, see CMVC 194130 or Defect 59613 -->
		<command>numactl --membind=0 $EXE$ -Xdump:java:events=user,file=javacore.txt -classpath $Q$$J9JAR$$Q$ com.ibm.j9.numa.LinuxNumaTest bind 0</command>
		<output regex="yes" type="success">.*TEST PASSED*</output>
		<output regex="yes" type="failure">.*TEST FAILED*</output>
 	</test>
	<test id="default, JVM interleave on">
		<!-- As of Java 9, interleaving is off by default -->
		<!-- Should result in interleave:0-n heap policy n=# of nodes -->
		<!-- If this fails, see CMVC 194130 or Defect 59613 -->
		<command>$EXE$ -Xdump:java:events=user,file=javacore.txt -classpath $Q$$J9JAR$$Q$ -XX:+InterleaveMemory com.ibm.j9.numa.LinuxNumaTest interleave</command>
		<output regex="yes" type="success">.*TEST PASSED*</output>
		<output regex="yes" type="failure">.*TEST FAILED*</output>
 	</test>
	<test id="interleaveOnlyNode0, JVM interleave on">
		<!-- 64-bit references, default policy limited to node 0 only -->
		<!-- Should result in interleave:0 heap policy, same effect as bind:0-->
		<!-- If this fails, see CMVC 194130 or Defect 59613 -->
		<command>numactl --membind=0 $EXE$ -XX:+InterleaveMemory -Xdump:java:events=user,file=javacore.txt -classpath $Q$$J9JAR$$Q$ com.ibm.j9.numa.LinuxNumaTest interleave 0</command>
		<output regex="yes" type="success">.*TEST PASSED*</output>
		<output regex="yes" type="failure">.*TEST FAILED*</output>
 	</test>
</suite>
